

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <title>Готово</title>

    <meta name="description" content="" />
    
    <!-- RSS -->

    <link rel="alternate" type="application/rss+xml" title="Сайт Влада" href="https://kostyanetsky.ru/rss.xml" />

    <!-- Icons -->

    <link rel="icon" href="https://kostyanetsky.ru/favicon.ico">
    <link rel="icon" href="https://kostyanetsky.ru/assets/icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="https://kostyanetsky.ru/assets/icons/apple-touch-icon.png">
    <link rel="manifest" href="https://kostyanetsky.ru/manifest.webmanifest">    

    <!-- Open Graph -->

    <meta property="og:title" content="Готово"/>
    <meta property="og:description" content=""/>
    <meta property="og:image" content="https://kostyanetsky.ru/assets/images/og.jpg">
    <meta property="og:type" content="article"/>
    <meta property="og:url" content= "https://kostyanetsky.ru/notes/tags/done" />    

    <!-- Tachyons -->

    <link rel="stylesheet" href="https://kostyanetsky.ru/assets/tachyons.min.css">

    <!-- Likely -->
    
    <script src="https://kostyanetsky.ru/assets/likely/likely.js"></script>
    <link rel="stylesheet" href="https://kostyanetsky.ru/assets/likely/likely.css">    

    <!-- Blog -->

    <script>

        let ctrlUpUrl       = 'https://kostyanetsky.ru/notes/tags/done';
        let ctrlDownUrl     = '';
        let ctrlLeftUrl     = '';
        let ctrlRightUrl    = '';

    </script>
    
    <link rel="stylesheet" href="https://kostyanetsky.ru/assets/blog.css">
    <script src="https://kostyanetsky.ru/assets/blog.js"></script>
                
</head>

<body class="w-100 bg-white">

<div id="app">        
<main>

<header class="db dt-l w-100-l border-box pa3 ph5-l">

    <nav class="flex items-center lh-copy pa3 ph0-l">
    
        <a href="https://kostyanetsky.ru"><img class="br-100" src="https://kostyanetsky.ru/assets/images/me.jpg" title="Привет!" /></a>

        <div class="pl4 flex-auto">
        
            
                <a class="dib f4 mr3 link dim bb blue" href="https://kostyanetsky.ru">Сайт Влада</a>
            

            
                <a class="dib f4 mr3 link dim bb blue" href="https://kostyanetsky.ru/projects/">Проекты</a>
                        

            
                <a class="dib f4 mr3 link dim bb orange" href="https://kostyanetsky.ru/notes/">Заметки</a>
            

        </div>
        
    </nav>
    
    <nav class="dtc-l v-mid tc tr-l">

        
            <a href="https://kostyanetsky.me/notes/tags/done" class="link f5 f5-ns dim blue bb">EN</a>
        

        

            <div class="mt3">

            
                    <span class="f4 f4-ns">✎</span>
            

            </div>
            
        

    </nav>

</header>

<section class="pa3 pa5-ns bt b--black-10 black-70 bg-white">
    

    <article>

        <h1 class="f-subheadline lh-solid">Готово</h1>

        

            <p class="mt5 mb3 f6">
                <a class="link blue bb dim mr1 mt3 mb3" href="https://kostyanetsky.ru/notes/tags/done">Позднее</a> Ctrl + &uarr;
            </p>

        

        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/data-size-console/">Размер данных базы 1С</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>На прошлой неделе листал комментарии к 8.3.15 и наткнулся на метод ПолучитьРазмерДанныхБазыДанных(). Стало любопытно, как эта штука работает и насколько её данные расходятся с теми, которые можно получить из, например, Management Studio.</p>
<p>В итоге накатал что-то вроде <a href="https://github.com/vkostyanetsky/DataSizeConsole" target="_blank">консоли</a>, через которую методу можно передавать разные метаданные, и принялся следить за запросами платформы к БД.</p>
<p>В общем, размер данных платформа считает примерно таким выражением:</p>
<pre><code>CAST(
    SUM(
        CAST(
            DATALENGTH(T1._Fld40) AS NUMERIC(12, 0)
        )
    ) AS NUMERIC(18, 0)
)
</code></pre>
<p>И так для каждого поля, которое есть у объекта, включая стандартные. Если есть табличные части — они тоже считаются. Результат суммируется.</p>
<p>Выводы?</p>
<p>Ну, во-первых, понятно, почему у метода такое дурацкое название. Он считает не размер таблиц, как я изначально подумал, а именно <strong>размер данных</strong> — то есть на оценку не влияют ни расходы на схему данных, ни расходы на индексы, ни механика экстентов. Учитывается только размер самих данных, которые хранятся непосредственно в объекте.</p>
<p>Таким образом, реальный объём места, которое слопал условный справочник номенклатуры, будет больше того, которое покажет метод. Возможно, значительно. Для точной аналитики такой подход не годится, но чтобы быстро оценить распределение данных в БД – вполне подходит. </p>
<p>Во-вторых, метод никак не считает расходы на историю данных для анализируемых объектов, что честно указано в документации. Теоретически их можно посчитать вручную, оттолкнувшись от _DataHistoryMetadata, но подождем релиз-другой — возможно, разработчики это добавят.</p>
<p>В-третьих, СУБД в ходе расчетов выгребает все содержимое нужных таблиц, а потом считает размер того, что выгребла. То есть вызов, скорее всего, приведет к куче сканирований и может быстро вымыть буферный кэш. На 1cFresh запросы будут делаться с учетом разделителей, но это слабое утешение, как по мне.</p>
<p>В общем, на работающем проде применять с осторожностью.</p>
        <p class="f6 mt4">
            2020-07-11
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/value-table-view/">Просмотр таблицы значений</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Закинул на GitHub <a href="https://gist.github.com/vkostyanetsky/ef44bbb18f36a1c51826a5d0b4f3960e" target="_blank">короткую функцию</a>, с помощью которой произвольную таблицу значений можно превратить в табличный документ.</p>
<p>Для чего? Чтобы посмотреть её содержимое. Саму таблицу на клиент передать нельзя, а вот табличный документ на её основе — можно. Кроме того, у табличного документа есть клиентский метод Show(), который отображает его в отдельном окне.</p>
<p>То есть можно прямо из режима предприятия просматривать разные служебные таблицы, не тратя время на создание интерфейса для них. Просто передаем их в функцию по ссылке выше, получаем табличные документы, возвращаем их на клиент и выводим.</p>
        <p class="f6 mt4">
            2020-05-16
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/is-ref-empty/">Пустая() или ЗначениеЗаполнено()?</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Несколько дней назад обсуждал с коллегой, какой способ проверки заполнения ссылки лучше. С одной стороны, время назад на каком-то курсе я слышал авторитетное мнение, что функцию ЗначениеЗаполнено() нужно использовать с осторожностью, так как её логика — сопоставлять переменную всем возможным пустым значениям, которые есть в конфигурации. И это, мол, огромная тормозная лапша. Как альтернативу автор курса советовал использовать метод ссылки Пустая(), а композитные реквизиты проверять примерно так:</p>
<pre><code>СсылкаЗаполнена = Ссылка &lt;&gt; Неопределено И Не Ссылка.Пустая();
</code></pre>
<p>Коллега в свою очередь утверждал, что ЗначениеЗаполнено() быстрее, так как это встроенная функция, которая не тратит время на поиск метода у объекта (в скриптовых языках это сравнительно медленная операция).</p>
<p>На моей памяти ни тот, ни другой метод узким местом никогда не были, но меня разобрало любопытство; написал <a href="https://github.com/vkostyanetsky/IsEmptyOrValueIsFilled" target="_blank">тест</a>, который проверяет ссылочную переменную на пустое значение обеими способами и замеряет время, которое было потрачено. </p>
<p>В среднем результат выглядит <a href="https://kostyanetsky.ru/notes/is-ref-empty/is-ref-empty.png" target="_blank">примерно так</a>. Там четыре шага — на первых двух предполагается, что ссылка определена, а на третьем и четвертом добавляется соответствующая проверка. В последней колонке таблицы виден контекст выполнения теста (клиент или сервер).</p>
<p>Вывод довольно очевиден: ЗначениеЗаполнено() никакой деградации не показывает, более того — работает быстрее, чем метод Пустая() (особенно если мы начинаем проверять переменную на Неопределено). Конечно, отклонение не слишком значительное, но на каких-то длительных регламентных операциях вполне можно сэкономить пару секунд.</p>
<p>Да и чисто практически проще делать проверку одним универсальным вызовом, а не пытаться угадать все возможные значения переменной.</p>
        <p class="f6 mt4">
            2020-04-11
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/standard-attributes-filtering/">Фильтрация стандартных реквизитов</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Короткий <a href="https://gist.github.com/vkostyanetsky/ee1f913868673c2218877dfbecc9b08a" target="_blank">фрагмент</a> кода из обработки для настройки механизма истории данных, о которой я только что <a href="https://kostyanetsky.ru/notes/data-history-settings" target="_blank">писал</a>. Эта функция определяет, является ли Attribute стандартным реквизитом с именем StandardAttributeName, принадлежащим объекту метаданных MetadataObject. Где она нужна? Допустим, вы перебираете стандартные реквизиты объекта и по какой-то причине хотите пропустить один из них.</p>
<p>На первый взгляд решение выглядит максимально индусским. Почему бы, например, просто не сравнить два реквизита — проверяемый и тот, что хотим отсеять?</p>
<pre><code>If Attribute = MetadataObject.StandardAttributes.Order Then
</code></pre>
<p>Дело в том, что такой код не сработает: результат операции сравнения двух стандартных реквизитов объекта метаданных в платформе 1С — всегда Ложь.</p>
<p>О'кей, скажете вы — может, тогда не будем усложнять и напишем вот так?</p>
<pre><code>If Attribute.Name = "Order" Then
</code></pre>
<p>Однако так тоже не сработает, если ваш код будет запущен в русскоязычной конфигурации: стандартный реквизит, который мы пытаемся найти, в этом случае будет называться «Порядок». </p>
<p>Тем не менее, к самому стандартному реквизиту внутри коллекции можно обращаться и по-русски, и по-английски. Потом получаем текущее имя атрибута и сравниваем с именем того атрибута, который проверяем.</p>
<p>Конечно, можно было просто сделать сравнение имени реквизита и с «Order», и с «Порядок» — но это, во-первых, некрасиво, а во-вторых — стандарты программирования у нас в компании запрещают писать код на русском. В общем, мне хотелось найти более общее решение.</p>
<p>Что до конструкции Try/Catch — она тут на тот случай, если стандартного реквизита с таким именем в конфигурации нет вообще (и попытка обратиться к нему  по имени приведет к ошибке).</p>
        <p class="f6 mt4">
            2020-03-09
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/data-history-settings/">Настройки истории данных</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Выложил на GitHub <a href="https://github.com/vkostyanetsky/AuditLogSettings" target="_blank">обработку</a> для настройки механизма истории данных, который сравнительно недавно <a href="https://its.1c.ru/db/v8312doc#bookmark:dev:TI000001938" target="_blank">появился</a> в платформе. Эта обработка:</p>
<ol>
<li>Строит дерево объектов, для которых может вестись история данных;</li>
<li>Подсказывает, для каких объектов история данных ведется сейчас;</li>
<li>Дает возможность включить или выключить историю данных для объектов и их реквизитов. </li>
</ol>
<p>Обработка поддерживает пакетные операции — например, можно включить историю разом для нескольких документов и всех справочников. Или вообще удалить все внесенные настройки, откатив состояние механизма к тому, которое заложил разработчик конфигурации.</p>
<p>По-моему, неплохо получилось. Я писал эту штуку больше для себя, разминая мозг по вечерам — но мы, возможно, даже включим её в <a href="https://firstbit.ae" target="_blank">нашу конфигурацию</a>! Сейчас версионированием данных в ней занимается SSLi, и её механизмы трудно назвать эффективными — медленные и сильно раздувают базу. Надеюсь, платформа на тестах покажет себя лучше.</p>
<p>На Инфостарте и ИТС можно найти похожие разработки, но они либо глючат, либо работают только на русскоязычных конфигурациях (не имеют английского интерфейса + опираются на БСП), либо просто-напросто устарели (например, не поддерживают работу с константами).</p>
        <p class="f6 mt4">
            2020-03-09
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/top-exceptions/">Топ исключений по ТЖ</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Выложил на GitHub <a href="https://github.com/vkostyanetsky/ScriptsFor1C/blob/master/Технологический%20журнал/FrequentExceptions.sh" target="_blank">скрипт</a> на баше, который по собранному технологическому журналу 1С определяет наиболее частотные исключения.</p>
<p>Скрипт анализирует события EXCP. Это основной источник информации об ошибках, хотя, конечно, не единственный: например, есть EXCPCNTX (событие, которое началось, но не закончилось в тот момент, когда произошла ошибка). Кроме того, если исключение происходит во время серверного вызова, то в поле RetExcp у события CALL будет текст ошибки, которая вернется на клиент.</p>
<p>Впрочем, в большинстве случаев EXCP и, иногда, EXCPCNTX вполне достаточно. Часто их собирают просто по умолчанию — нагрузки это не создает, зато позволяет прогонять собранные логи через какой-нибудь инструмент аналитики (скрипт выше, например) и держать, так сказать, руку на пульсе.</p>
        <p class="f6 mt4">
            2020-02-16
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/bash/">bash</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/fifty-times-faster/">В пятьдесят раз быстрее</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Получил вводную: документ закрытия месяца у заказчика проводится без малого час. База не особенно большая, но такая продолжительность в любом случае не вариант. Даже если учесть, что закрытие месяца — это ни разу не частотная операция и её можно делать, например, ночью.</p>
<p>Лезу в код, делаю замер производительности и вижу, что и почти всё это время платформа тратит на одну-единственную процедуру, выполняя пакет запросов. Смотрю <a href="https://gist.github.com/vkostyanetsky/cf34c6cb088515e2bab6485b2f35eab8" target="_blank">первый</a> из них; ну, думаю, классика — запрос данных через точку от составного типа. Наверняка СУБД пристегивает целый вагон соединений с тяжеленными таблицами документов, вот оптимизатор и не успевает набросать адекватный план.</p>
<p>Проверяю теорию — так, а тип SalesDocument включает всего восемь документов. Это, условно, в пределах допустимого (считается, что оптимизатор в состоянии подобрать адекватный план выполнения запроса, если количество соединений — в пределах восьми).</p>
<p>Смотрю размеры таблиц документов — не особенно-то и большие. Выполняю запрос отдельно от пакета — да, работает не мгновенно (читает около 350 000 записей и отбирает примерно 200 000), но никак не час.</p>
<p>Ладно, первый запрос пакета тяжелый, но проблема не в нём. Лезу во <a href="https://gist.github.com/vkostyanetsky/f4423dcfb28d4a27039c7310c13c3a73" target="_blank">второй</a> и понимаю, что до этого прочитали весь регистр Inventory и отобрали большую часть записей, а теперь — читаем его ещё раз и склеиваем обе выборки по куче условий. Подходящего индекса в таблице движений нет — только стандартный по регистратору и он, конечно, не подходит.</p>
<p>Проверил — именно тут платформа и проводит большую часть времени, ожидая ответа от СУБД.</p>
<p>Отказаться от двойного чтения всей таблицы регистра не вышло: я перебрал несколько вариантов, но все они требовали изменения структуры хранения данных, что было неприемлемо. В итоге остановился на промежуточном варианте: во втором запросе соединение с реальной таблицей движений регистра заменилось на соединение с заранее созданной временной таблицей, проиндексированной по полям соединения.</p>
<p>Это тот случай, когда общая рекомендация 1С сработала идеально — вместо 50 минут документ стал проводиться за три, а после дополнительной оптимизации кода — за минуту. То есть, в пятьдесят раз быстрее того, что я имел вначале.</p>
<p>Такой результат я счел достаточным (минута для закрытия месяца — это в общем случае нормально) и остановился.</p>
        <p class="f6 mt4">
            2019-12-05
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/optimization/">оптимизация</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/find-methods-with-parameter/">Поиск методов с параметром</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Задача: нужно найти в общих модулях конфигурации методы с определенным параметром (в этом примере — с параметром DecimalPlacesFor).</p>
<p>Обычный поиск по коду конфигурации даст массу ложных срабатываний (например, все обращения к параметру с таким именем в теле методов). Поиск по регулярным выражениям платформа пока не поддерживает, поэтому выгодно выгрузить конфигурацию в файлы и натравить на папку общих модулей <a href="https://github.com/vkostyanetsky/ScriptsForLogAnalysis/blob/master/Файлы%20конфигурации/MethodsWithParameter.sh" target="_blank">скрипт</a> на баше.</p>
<p>Первая часть скрипта (до пайпа) выполняет сам поиск, вторая — отрезает лишнее, чтобы на вывод уходили только названия модулей и найденных в них методов. Получится, например, так:</p>
<p><img alt="Скриншот консоли" src="https://kostyanetsky.ru/notes/find-methods-with-parameter/bash.png"/></p>
<p>Профит? Профит!</p>
        <p class="f6 mt4">
            2019-11-18
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/bash/">bash</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/vue-i18n/">Мультиязычность в Vue.js</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Я веду этот сайт на русском языке, но есть и <a href="https://kostyanetsky.me" target="_blank">зеркало</a> на английском — туда я постепенно перевожу то, что написал здесь. Поддерживать два набора скриптов я не хочу, поэтому оба домена ссылаются на один и тот же сервер, который определяет, с какого домена пришел запрос — и выводит ответ на соответствующем языке.</p>
<p>Звучит просто, но на самом деле эта задача рождает довольно много дополнительных проблем, и одна из них — вывод интерфейса. Сначала я <s>по привычке</s> завел на клиенте два массива с фразами на разных языках, но быстро выкинул этот велосипед и прикрутил <a href="https://www.npmjs.com/package/vue-i18n" target="_blank">Vue I18n</a>.</p>
<p>На нижнем уровне это, правда, всё те же <a href="https://kazupon.github.io/vue-i18n/guide/formatting.html#named-formatting" target="_blank">два массива</a> с фразами (их нужно задать при инициализации), однако выгода здесь в другом. Этот плагин сам по себе закрывает еще две проблемы с генерацией интерфейса:</p>
<ol>
<li><a href="https://kazupon.github.io/vue-i18n/guide/pluralization.html" target="_blank">Склонение существительных</a>. Нужно, чтобы правильно выводить слово «страница» в <a href="https://kostyanetsky.ru/notes/tags" target="_blank">статистике по тегам</a> — одна заметка, две заметки, пять заметок и так далее.</li>
<li><a href="https://kazupon.github.io/vue-i18n/guide/datetime.html" target="_blank">Вывод дат</a>. Например, дата под этой заметкой.</li>
</ol>
<p>Обе задачи, конечно, можно было закрыть на стороне сервера, силами PHP, но я счел это некрасивым решением. Сервер должен возвращать данные, клиент — строить интерфейс. Нечего их смешивать.</p>
        <p class="f6 mt4">
            2019-06-25
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/blog/">блог</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/webdev/">вебдев</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/duplicate-key/">Повторяющийся ключ</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>На Инфостарте вышла любопытная <a href="https://infostart.ru/public/1010017/" target="_blank">статья</a> про ошибку СУБД «cannot insert duplicate key». Одна из возможных причин сбоя — использование уникального идентификатора объекта для сопоставления при обмене с другими информационными базами (то есть, без служебного регистра, сопоставляющего объекты базы данных с идентификаторами объектов внешней базы).</p>
<p>Такой жести, чтобы уникальные идентификаторы совпали в разных базах для одной и той же таблицы, у меня в практике пока не было. Однако от подхода «единого идентификатора» я отрекся окончательно после того, как делал обмен между <a href="https://firstbit.ae/products/erp-dubai/financial_management/" target="_blank">FirstBIT ERP</a> и <a href="http://superagent.ru/products/grotem_agent" target="_blank">GROTEM / Agent</a>.</p>
<p>Архитектура пилотного решения была такая: данные из FirstBIT ERP выгружались сперва в служебную ИБ 1С, написанную разработчиками GROTEM'а, а уже оттуда — в основную базу данных сервера мобильных приложений.</p>
<p>Сопоставление было сделано очень просто — через идентификаторы объектов. Например, один и тот же документ в обеих базах имел один и тот же идентфикатор. Но были и более сложные схемы: например, контрагент FirstBIT ERP на стороне GROTEM'а превращался в три объекта: собственно контрагента, торговую точку и документ взаиморасчетов.</p>
<p><img alt="WAIT WHAT" src="https://media.giphy.com/media/zkSFsZpQMZuG4/giphy.gif"/></p>
<p>Да, в документ взаиморасчетов. И все три объекта имели один и тот же идентфикатор — идентификатор контрагента FirstBIT ERP. В общем, не то чтобы это было очень изящным решением, но для платформы такой расклад вполне адекватен и мы решили, что проблем быть не должно.</p>
<p>Однако обмен работать отказался.</p>
<p>Беглый анализ показал, что данные успешно выгружаются в промежуточную базу данных и проходят все возможные проверки на целостность и полноту, а не работает только финальный шаг — выгрузка в базу данных сервера мобильных приложений.</p>
<p>В итоге выяснилось, что:</p>
<ol>
<li>В этой самой базе есть таблица, где хранятся все интересующие нас объекты. Документы, элементы справочников, вот это всё.</li>
<li>Эта таблица имеет уникальный индекс по GUID объекта.</li>
</ol>
<p>В этом месте интрига закончилась. Ну да, первый же выгруженный контрагент создавал целых три сущности с одним и тем же GUID, которые прекрасно лежали в своих таблицах на стороне 1С, но не могли быть записаны в одну общую таблицу базы данных приложения.</p>
<p><img alt="I will not use GUIDs to map objects!" src="https://kostyanetsky.ru/notes/duplicate-key/i-will-not-use-guids.gif"/></p>
        <p class="f6 mt4">
            2019-03-01
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/failed-hunt/">Неудачная охота</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>При обновлении платформы до 8.13.12.1790 наткнулись на плавающий баг при переключении текущей страницы элемента на сервере. Конкретно на сервере оно срабатывает, но как только управление возвращается на клиент — текущей страницей становится та, что была до изменения. При этом ещё и происходит событие изменения текущей страницы (как будто пользователь сменил её вручную).</p>
<p>Неприятно, но, в общем, ничего страшного — запатчили баг, описали и зарепортили в 1С. Там пока <a href="https://bugboard.v8.1c.ru/error/000050675.html" target="_blank">думают</a>. Но я, внезапно, даже как-то расстроен — когда расследуешь такие штуки, они всегда выглядят немного загадочно и кажется, что ты вот-вот найдешь что-то интересное! Например, новый аспект работы платформы или что-то вроде этого.</p>
<p>И вот, наконец, ты смотришь на проблему под правильным углом, а она — обычный жук. Возможно, полосатый или в крапинку, но жук как жук — сидит себе, шевелит усами. И ты такой: блин, это что — и есть моя добыча? :-)</p>
        <p class="f6 mt4">
            2019-02-21
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/rights-for-dcs/">СКД и право просмотра</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Универсальный подход системы компоновки данных «если у пользователя нет права на просмотр чего-то, то этого как бы нет» иногда заставляет платформу выкидывать знатные фортели. Нет, сферический отчет в вакууме и правда работает хорошо — например, если нет права на просмотр какого-то справочника, то в отчете он фигурировать не будет. Однако реальные примеры бывают посложнее.</p>
<p>Например, пару недель назад я отлаживал отчет, который при попытке генерации выдавал понятную на первый взгляд ошибку:</p>
<p><img alt="У вас настройка кривая, товарищ!" src="https://kostyanetsky.ru/notes/rights-for-dcs/ru.png"/></p>
<p>Отчет гигантский — запрос на добрую тысячу строк, сложная настройка, здоровенный макет, запутанный код компоновки. Первое подозрение пало на ошибку в настройке, но расследование быстро дошло от ссылки на валюту в выборке данных до чтения константы с этой валютой на самом нижнем уровне отчета, на которую не было права просмотра.</p>
<p>Не скажу сходу, что именно тут сбило платформу с толку и привело к не очевидной диагностике — то ли манипуляции с временной таблицей, куда эта константа была прочитана, то ли то, что читалась она в конструкции ВЫБОР, то ли то, что на сам справочник валют все необходимые права были. Искать конкретное условие или их сочетания я не стал — думаю, это просто специфика реализации движка СКД, которая может меняться от версии к версии. Достаточно не забывать о праве просмотра, и проблемы не будет.</p>
<p>Что касается ошибки, при столкновении с ней стоит вывести проблемный отчет под полными правами. Если тут всё о'кей, нужно набросать список таблиц, откуда отчет читает данные, и проверить — все ли они с правами на чтение и просмотр.</p>
<p>Нудно, но может сэкономить прилично времени.</p>
        <p class="f6 mt4">
            2018-08-28
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/fce-results/">Результаты FCE</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Кембридж прислал результаты июньских экзаменов. И — вступают трубы — FCE я сдал! Судя по баллам, ухитрился в чём-то налажать во время письменной части, зато неплохо отыгрался во время разговорной. Жаль, что экзаменаторы не дают более подробных комментариев; впрочем, и так понятно, куда дальше воевать :) Преподаватель заметила, что раньше вообще сообщали только итоговый балл — мол, понимайте как хотите, уважаемые претенденты.</p>
<p>В общем, в следующем году перевешу планку повыше — видимо, нужно готовиться к CAE.</p>
<p>По этому поводу вспомнился Фейнман со своей знаменитой «Вы, конечно, шутите». Среди прочего он рассказывал, как во время жизни в Бразилии учился играть на фригидейре и доучился до того, что его стали ставить в пример местным музыкантам:</p>
<blockquote>
<p>Я думаю, это напоминает ситуацию, когда человек, который говорит по-французски, приезжает в Америку. Сначала он делает все ошибки, которые можно сделать, и понимать его очень сложно. Но он непрерывно занимается, до тех пор пока не начинает говорить довольно хорошо, и манера речи этого человека начинает доставлять вам истинное удовольствие: у него очень милый акцент, и его приятно слушать.</p>
<p><em>― Ричард Фейнман</em></p>
</blockquote>
<p>Между «все ошибки» и «приятно слушать» непринужденно опущено целое море труда, но в целом этот синопсис мне нравится. Работаем куда-то туда!</p>
        <p class="f6 mt4">
            2018-07-15
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/books/">книги</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/english/">английский</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/bus-trips-uploading/">Выгрузка автобусных рейсов</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>С тех пор, как мы с коллегами заново автоматизировали <a href="http://kpat.ru/" target="_blank">КПАТ</a>, она работает на «<a href="http://avibus.pro/standalone/" target="_blank">Управлении автовокзалами</a>». Это конфигурация для 1С:Предприятия, то есть её можно сравнительно быстро интегрировать почти с чем угодно.</p>
<p>Первым делом мы решили наладить выгрузку маршрутного расписания автобусов на E-Traffic и Яндекс.Расписания.</p>
<h2>Что это за ресурсы?</h2>
<p>Первый ресурс, <a href="http://e-traffic.ru" target="_blank">E-Traffic</a> — это крупнейший в России агрегатор данных автовокзалов. Собирает информацию о запланированных рейсах и выступает как агент по продаже электронных билетов. То есть пассажирам не нужно продираться через сайты автовокзалов — на E-Traffic можно купить билет откуда угодно куда угодно.</p>
<p>Что касается <a href="http://rasp.yandex.ru" target="_blank">Яндекс.Расписаний</a> — это один из дочерних проектов российского поисковика. Как и E-Traffic, предназначен в первую очередь для пассажиров и умеет быстро строить относительно сложные маршруты с пересадками. Билетами они, правда, не торгуют.</p>
<h2>Как была сделана выгрузка?</h2>
<p>Поначалу мы нагородили довольно сложную архитектуру, позволяющую транслировать расписание в обе системы. Потели как черти — пока в ходе переговоров не выяснилось, что у E-Traffic уже есть рабочий транспорт для передачи расписания в Яндекс, и задача естественным образом не усохла вдвое.</p>
<p>Технически всё было сделано в виде веб-сервиса для «Управления автовокзалами». Получив SOAP-запрос от E-Traffic, он собирал внутри информационной базы 1С:Предприятия все необходимые данные о запланированных автобусных рейсах и возвращал их в виде XML-ки.</p>
<p>Нам даже не пришлось писать код получения расписания с каждого вокзала, входящего в сеть КПАТ'а: все они создаются и хранятся в одном месте — главном узле РИБ, а веб-сервис мы развернули именно там. В итоге больше времени ушло на разные согласования, чем на программирование.</p>
<h2>А где посмотреть?</h2>
<p>Внутренняя кухня снаружи не видна, да и там ничего необычного — роботы общаются с роботами, эка невидаль :-) Результат их болтовни — куда интереснее! Например, вот <a href="https://rasp.yandex.ru/search/bus/?fromName=Кемерово&amp;toName=Новокузнецк&amp;fromId=c64&amp;toId=c237&amp;when=сегодня" target="_blank">расписание</a> рейсов из Кемерово в Новокузнецк на сегодня.</p>
        <p class="f6 mt4">
            2017-11-17
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

        

    </article>


</section>

</main>

<footer class="ph3 ph4-ns pv4 bt b--black-10 black">
    
    <p class="f6 lh-solid">Эл. почта: <a href="mailto:vlad@kostyanetsky.ru" class="link dim bb black">vlad@kostyanetsky.ru</a></p>
    <p class="f6 lh-solid">Телеграм: <a href="tg://resolve?domain=vkostyanetsky" class="link dim bb black">vkostyanetsky</a></p>
    <p class="f6 lh-solid">Гитхаб: <a href="https://github.com/vkostyanetsky" class="link dim bb black">vkostyanetsky</a></p>
    
    <a class="rss" href="https://kostyanetsky.ru/rss.xml">РСС</a> 

</footer>

</div>
</body>
</html>