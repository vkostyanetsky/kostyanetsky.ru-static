

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <title>Работа</title>

    <meta name="description" content="" />
    
    <!-- RSS -->

    <link rel="alternate" type="application/rss+xml" title="Сайт Влада" href="https://kostyanetsky.ru/rss.xml" />

    <!-- Icons -->

    <link rel="icon" href="https://kostyanetsky.ru/favicon.ico">
    <link rel="icon" href="https://kostyanetsky.ru/assets/icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="https://kostyanetsky.ru/assets/icons/apple-touch-icon.png">
    <link rel="manifest" href="https://kostyanetsky.ru/manifest.webmanifest">    

    <!-- Open Graph -->

    <meta property="og:title" content="Работа"/>
    <meta property="og:description" content=""/>
    <meta property="og:image" content="https://kostyanetsky.ru/assets/images/og.jpg">
    <meta property="og:type" content="article"/>
    <meta property="og:url" content= "https://kostyanetsky.ru/notes/tags/work" />    

    <!-- Tachyons -->

    <link rel="stylesheet" href="https://kostyanetsky.ru/assets/tachyons.min.css">

    <!-- Likely -->
    
    <script src="https://kostyanetsky.ru/assets/likely/likely.js"></script>
    <link rel="stylesheet" href="https://kostyanetsky.ru/assets/likely/likely.css">    

    <!-- Blog -->

    <script>

        let ctrlUpUrl       = 'https://kostyanetsky.ru/notes/tags/work';
        let ctrlDownUrl     = 'https://kostyanetsky.ru/notes/tags/work/page-3';
        let ctrlLeftUrl     = '';
        let ctrlRightUrl    = '';

    </script>
    
    <link rel="stylesheet" href="https://kostyanetsky.ru/assets/blog.css">
    <script src="https://kostyanetsky.ru/assets/blog.js"></script>
                
</head>

<body class="w-100 bg-white">

<div id="app">        
<main>

<header class="db dt-l w-100-l border-box pa3 ph5-l">

    <nav class="flex items-center lh-copy pa3 ph0-l">
    
        <a href="https://kostyanetsky.ru"><img class="br-100" src="https://kostyanetsky.ru/assets/images/me.jpg" title="Привет!" /></a>

        <div class="pl4 flex-auto">
        
            
                <a class="dib f4 mr3 link dim bb blue" href="https://kostyanetsky.ru">Сайт Влада</a>
            

            
                <a class="dib f4 mr3 link dim bb blue" href="https://kostyanetsky.ru/projects/">Проекты</a>
                        

            
                <a class="dib f4 mr3 link dim bb orange" href="https://kostyanetsky.ru/notes/">Заметки</a>
            

        </div>
        
    </nav>
    
    <nav class="dtc-l v-mid tc tr-l">

        
            <a href="https://kostyanetsky.me/notes/tags/work" class="link f5 f5-ns dim blue bb">EN</a>
        

        

            <div class="mt3">

            
                    <span class="f4 f4-ns">✎</span>
            

            </div>
            
        

    </nav>

</header>

<section class="pa3 pa5-ns bt b--black-10 black-70 bg-white">
    

    <article>

        <h1 class="f-subheadline lh-solid">Работа</h1>

        

            <p class="mt5 mb3 f6">
                <a class="link blue bb dim mr1 mt3 mb3" href="https://kostyanetsky.ru/notes/tags/work">Позднее</a> Ctrl + &uarr;
            </p>

        

        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/one-query-to-rule-them-all/">Один запрос, что правит всеми</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Истории ради <a href="https://gist.github.com/vkostyanetsky/ddb286da9674b05d014389bed3b022c4" target="_blank">закинул</a> на Github Gist один из неоптимальных запросов, с которыми возился несколько месяцев назад. Он использовался для динамического списка в форме элемента справочника и, когда пользователь открывал вкладку с этим списком, платформа погружалась в медитацию даже в относительно небольшой базе.</p>
<p>На первый взгляд структура запроса простая и четкая: пачка запросов к таблицам документов, соединяемых через ОБЪЕДИНИТЬ ВСЁ. Каждая из таблиц фильтруется по примерно одинаковым условиям — тип ссылки, дата и вхождение ссылки в результат подзапроса.</p>
<p>Однако потенциальных проблем тут сразу несколько. Во-первых, работа идет как минимум с 14-ю таблицами — по числу соединяемых запросов. Это само по себе повышает риск того, что оптимизатор не успеет подобрать хотя бы относительно приличный план выполнения. Скорее всего, он просто ткнет пальцем в небо, а дальше — как повезет.</p>
<p>Во-вторых, большая часть этой работы, вероятно, будет выполняться впустую. Каждый из запросов содержит примерно такую конструкцию:</p>
<pre><code>WHERE VALUETYPE(AdditionalExpenses.Ref) IN (&amp;DocumentsListSelectedTypes)
</code></pre>
<p>То есть в динамический список передается список типов документов, которые требуется вывести. Однако это условие будет наложено <strong>после</strong> выборки данных, и если пользователю нужны только инвойсы — СУБД все равно сначала выгребет все 14 таблиц, а потом отбросит 13 из них.</p>
<p>Но это всё не так критично. Если бы список проблем этим и ограничивался, мы, возможно, и не полезли бы разбираться. Главная проблема — во втором условии секций WHERE: каждый запрос проверяет вхождение ссылки на документ в результат подзапроса.</p>
<p>Использование вложенного запроса в условиях — само по себе почти табу, если речь идет не о временных таблицах: СУБД часто не в состоянии понять, сколько данных вернет подзапрос и, соответственно, какой способ работы с ними подойдет лучше. Однако тут это ещё и усугубляется тем, к какому источнику данных мы делаем запрос. Критерий отбора — это не таблица в базе данных, которую можно прочитать, пусть даже со сканом — это набор таблиц. В критерии отбора DocumentsByProject их тридцать!</p>
<p>В этом месте можно было бы сказать «занавес», но нужно добавить, что выборку из тридцати таблиц по определенному типу документа делает каждый из четырнадцати соединяемых запросов.</p>
<p><img alt="OMG" src="https://media.giphy.com/media/oYtVHSxngR3lC/giphy.gif"/></p>
<p>Вот теперь занавес :-)</p>
        <p class="f6 mt4">
            2020-07-25
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/optimization/">оптимизация</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/what-is-inside-the-drum/">Выгрузка стандартных обработок</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Недавно внедрили в нашу конфигурацию встроенный в платформу механизм истории данных вместо морально и функционально устаревшего велосипеда из SSLi. Сейчас как раз дописываю выгрузку историю данных в бэкап и загрузку его обратно: удивительно, но этого пока не умеет ни БСП, ни БТС, ни SSLi (впрочем, от последней я и не ждал).</p>
<p>Как закончу, расскажу подробнее. Пока хочу отметить любопытную опцию, которая пригодилась по ходу дела: встроенные в платформу обработки, которые доступны из меню «Все функции», можно выгрузить в виде обычных epf-файлов! Трюк очень подробно разобрали коллеги на Инфостарте (<a href="https://infostart.ru/public/369487/" target="_blank">вот тут</a> и <a href="https://infostart.ru/public/538300/" target="_blank">вот тут</a>). Вкратце магия выглядит вот так:</p>
<pre><code>КопироватьФайл(
    "v8res://mngbase/StandardDataChangeHistory.epf",
    "Q:/StandardDataChangeHistory.epf"
);
</code></pre>
<p>Полный список стандартных форм и обработок, которые можно вытащить, способ получения этого списка, а также куча споров вокруг и около — по ссылкам выше.</p>
<p>Зачем это пригодится вам — честно, не знаю. Что касается нас, то мы делали интерфейсы для работы с историей данных и было любопытно, как они написаны у самой 1С (спойлер: довольно неряшливо).</p>
        <p class="f6 mt4">
            2020-07-05
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/perfectly-balanced/">Об идеальном балансе</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Хочу поделиться парой классных текстов о современном софте. Они не особенно свежие (первый-то уж точно), но наверняка ведь кто-то пропустил:</p>
<ul>
<li><a href="https://tonsky.me/blog/disenchantment/ru/" target="_blank">Моё разочарование в софте</a> Никиты Тонского</li>
<li><a href="https://habr.com/ru/company/jugru/blog/493178/" target="_blank">В софте всё восхитительно, но все недовольны</a> Евгения Трифонова</li>
</ul>
<p>К чему я это вспомнил? На прошлой неделе участвовал в хакатоне среди программистов нашей компании. Узнал кучу клевых штук, а по итогам даже занял первое место (вместе с ещё двумя участниками, у которых получились очень похожие решения).</p>
<p>(если вы — тоже сотрудник «Первого БИТа», то <a href="https://newportal.1cbit.ru/news/3066979/" target="_blank">итоги</a> хакатона лежат на портале; там же — <a href="https://newportal.1cbit.ru/news/3066980/" target="_blank">отзыв</a> другого победителя, Димы Лещенко)</p>
<p>В процессе нужно было развернуть и настроить целую гору софта: EDT, RabbitMQ, Docker, GitLab, JIRA, SonarQube и ещё вагон инструментов поменьше и попроще. Ладно, к RabbitMQ у меня претензий нет: легкий и быстрый, но вот остальное… Про хороший аппетит EDT я знал и раньше, а вот прожорливость GitLab и JIRA по-настоящему удивила.</p>
<p>Да, в моём случае всё запускалось в докере; да, конфигурация не была оптимальной (например, было развернуто несколько серверов PostgreSQL вместо одного); да, докер был для Windows, а его реализация под эту платформу — тема для едких шуток у всех сисадминов, с которыми я знаком. Но потратить 12 гигабайт ОЗУ прямо со старта?! Про процессор вообще молчу — нагрузка была такая, будто компьютер просчитывал ядерный взрыв в реальном времени.</p>
<p>Короче, лучшей иллюстрации к тезисам Никиты подобрать трудно: софт выше слопал море ресурсов и невозмутимо попросил ещё, даже не приступив к какой-то понятной задаче. Впрочем, в то же время это отличная иллюстрация к тексту Евгения: я, на секундочку, одной-единственной командой развернул несколько операционных систем со сложными серверами внутри. И потратил на это несоизмеримо меньше времени чем, скажем, пришлось бы потратить несколько лет назад.</p>
<p>У меня нет ответа. Думаю, ни у кого нет. Это такой вечный холивар внутри профессии: какую сторону не займи, на деле все равно балансируешь между двумя крайностями — с одной стороны, надо писать хороший, быстрый код, с другой — надо не свалиться в преждевременную оптимизацию. Первое в итоге дает чистое удовольствие от хорошо сделанной работы: вспоминаешь, что ты, черт побери, неплох! Второе — просто позволяет не нажить бед с башкой в поисках идеального алгоритма сортировки пузырьком :-)</p>
        <p class="f6 mt4">
            2020-05-20
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/data-history-settings/">Настройки истории данных</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Выложил на GitHub <a href="https://github.com/vkostyanetsky/AuditLogSettings" target="_blank">обработку</a> для настройки механизма истории данных, который сравнительно недавно <a href="https://its.1c.ru/db/v8312doc#bookmark:dev:TI000001938" target="_blank">появился</a> в платформе. Эта обработка:</p>
<ol>
<li>Строит дерево объектов, для которых может вестись история данных;</li>
<li>Подсказывает, для каких объектов история данных ведется сейчас;</li>
<li>Дает возможность включить или выключить историю данных для объектов и их реквизитов. </li>
</ol>
<p>Обработка поддерживает пакетные операции — например, можно включить историю разом для нескольких документов и всех справочников. Или вообще удалить все внесенные настройки, откатив состояние механизма к тому, которое заложил разработчик конфигурации.</p>
<p>По-моему, неплохо получилось. Я писал эту штуку больше для себя, разминая мозг по вечерам — но мы, возможно, даже включим её в <a href="https://firstbit.ae" target="_blank">нашу конфигурацию</a>! Сейчас версионированием данных в ней занимается SSLi, и её механизмы трудно назвать эффективными — медленные и сильно раздувают базу. Надеюсь, платформа на тестах покажет себя лучше.</p>
<p>На Инфостарте и ИТС можно найти похожие разработки, но они либо глючат, либо работают только на русскоязычных конфигурациях (не имеют английского интерфейса + опираются на БСП), либо просто-напросто устарели (например, не поддерживают работу с константами).</p>
        <p class="f6 mt4">
            2020-03-09
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/ninth-wave/">Девятый вал</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Покупал вчера утром подарки своим женщинам. Пока флорист собирала букеты, болтал с ней ни о чем и случайно перехватил взгляд в сторону нарастающей толпы покупателей — спокойный такой, с отчетливо читающейся обреченностью. Так моряки, наверное, смотрят на вздымающуюся волну, которая вот-вот похоронит их шлюпку :-)</p>
<p>Люди вне цветочной индустрии иногда хмыкают — мол, восьмое марта это такой волшебный праздник для цветочников, которые делают целое состояние за десять часов. Касса в эти дни и правда собирается приличная — только вот у любого, кто когда-либо работал в этой сфере, восьмое (и пара дней до него, кстати) чаще ассоциируется с чудовищной нагрузкой на силы, нервы и здоровье.</p>
<p>Я, можно сказать, ещё дешево отделался: всего-то разворачивал и обслуживал айти в местной сети цветочных магазинов (кстати, <a href="http://rosetta.florist/" target="_blank">рекомендую</a> бывших коллег!). И всё равно запах цветов ещё долго вызывал у меня вьетнамский синдром.</p>
        <p class="f6 mt4">
            2020-03-09
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/meanwhile/">тем временем</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/1001-nights-with-1c/">Тысяча и одна ночь с 1С</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <iframe allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/WvdfWMoI1oI" width="560"></iframe>
<p>Архитектор нашего основного продукта (и, по совместительству, мой тимлид) рассказывает о том, как мы внедряли 1С в Дубае. Погружений в технические детали нет, так что можно смотреть всем, кто хотя бы чуть-чуть в теме.</p>
<p>Видео записано на краснодарской конференции разработчиков в июне прошлого года, так что кое-что уже поменялось. Например, у нас появились вполне рабочие прототипы программы на арабском языке, а объём автотестирования вырос настолько, что мисс <a href="https://github.com/Pr-Mex/vanessa-automation-single" target="_blank">Ванессу</a> стоит считать отдельным членом команды :-)</p>
        <p class="f6 mt4">
            2020-01-16
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/fifty-times-faster/">В пятьдесят раз быстрее</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Получил вводную: документ закрытия месяца у заказчика проводится без малого час. База не особенно большая, но такая продолжительность в любом случае не вариант. Даже если учесть, что закрытие месяца — это ни разу не частотная операция и её можно делать, например, ночью.</p>
<p>Лезу в код, делаю замер производительности и вижу, что и почти всё это время платформа тратит на одну-единственную процедуру, выполняя пакет запросов. Смотрю <a href="https://gist.github.com/vkostyanetsky/cf34c6cb088515e2bab6485b2f35eab8" target="_blank">первый</a> из них; ну, думаю, классика — запрос данных через точку от составного типа. Наверняка СУБД пристегивает целый вагон соединений с тяжеленными таблицами документов, вот оптимизатор и не успевает набросать адекватный план.</p>
<p>Проверяю теорию — так, а тип SalesDocument включает всего восемь документов. Это, условно, в пределах допустимого (считается, что оптимизатор в состоянии подобрать адекватный план выполнения запроса, если количество соединений — в пределах восьми).</p>
<p>Смотрю размеры таблиц документов — не особенно-то и большие. Выполняю запрос отдельно от пакета — да, работает не мгновенно (читает около 350 000 записей и отбирает примерно 200 000), но никак не час.</p>
<p>Ладно, первый запрос пакета тяжелый, но проблема не в нём. Лезу во <a href="https://gist.github.com/vkostyanetsky/f4423dcfb28d4a27039c7310c13c3a73" target="_blank">второй</a> и понимаю, что до этого прочитали весь регистр Inventory и отобрали большую часть записей, а теперь — читаем его ещё раз и склеиваем обе выборки по куче условий. Подходящего индекса в таблице движений нет — только стандартный по регистратору и он, конечно, не подходит.</p>
<p>Проверил — именно тут платформа и проводит большую часть времени, ожидая ответа от СУБД.</p>
<p>Отказаться от двойного чтения всей таблицы регистра не вышло: я перебрал несколько вариантов, но все они требовали изменения структуры хранения данных, что было неприемлемо. В итоге остановился на промежуточном варианте: во втором запросе соединение с реальной таблицей движений регистра заменилось на соединение с заранее созданной временной таблицей, проиндексированной по полям соединения.</p>
<p>Это тот случай, когда общая рекомендация 1С сработала идеально — вместо 50 минут документ стал проводиться за три, а после дополнительной оптимизации кода — за минуту. То есть, в пятьдесят раз быстрее того, что я имел вначале.</p>
<p>Такой результат я счел достаточным (минута для закрытия месяца — это в общем случае нормально) и остановился.</p>
        <p class="f6 mt4">
            2019-12-05
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/optimization/">оптимизация</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/duct-tape/">На, мужик, изоленту</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Начитанные друзья иногда спрашивают — мол, какая у тебя любимая книга? Мне, блин, всегда чутка стыдно отвечать на этот вопрос, потому что при всём том огромном выборе, который есть, это «Марсианин» Энди Вейера.</p>
<p>Если опустить то, что это классный приключенческий роман, то причина проста: как программист, я чувствую необыкновенное духовное родство с человеком, который решил кучу сложных инженерных проблем с помощью изоленты.</p>
<blockquote>
<p>Да, разумеется, изолента работает почти в вакууме. Изолента работает почти везде и повсюду. Изолента — это дар богов, ей нужно поклоняться.</p>
<p><em>― Энди Вейер, «Марсианин»</em></p>
</blockquote>
        <p class="f6 mt4">
            2019-08-02
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/books/">книги</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/burned-people/">И приятнее пахнуть</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>На днях выпустили очередный релиз FirstBIT ERP (наш программный продукт для автоматизации бизнеса в ОАЭ). Вложен вагон труда, всё работает как надо, есть чем гордиться и всё такое. Я, например, кучу сил потратил на то, чтобы сделать полноценный обмен данными с Битрикс24 и порядком рад, что успел этот механизм зафиналить.</p>
<p>Но в душе всё равно немного завидно <a href="https://steamcommunity.com/games/505230/announcements/detail/1597002662743679418" target="_blank">коллегам</a> из геймдева: наши патчноуты, конечно, тоже интересные, но <a href="https://kostyanetsky.ru/notes/burned-people/better.png" target="_blank">такого</a> там всё-таки не встретить.</p>
        <p class="f6 mt4">
            2019-06-10
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/videogames/">видеоигры</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/bitrix/">Битрикс</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/fat-roles/">Растолстевшие роли</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Очень любопытная <a href="https://start1c.blogspot.com/2019/01/blog-post.html" target="_blank">заметка</a> про неприятности, которые можно нажить командой роли «Снять все права». Нет, никакого криминала, права-то она честно снимает — только вот её вызов может привести к тому, что объект роли на пустом месте сожрёт в несколько раз больше памяти, чем ему реально нужно.</p>
<p>Прочитал, задумался и пошел проверять, как обстоят дела с этим у нас в конфигурации. И что бы вы думали? Накопал десятка два ролей, доверху набитых «снятыми галочками». Выгрузка прав весила около трёхста мегабайт, а после оптимизации — усохла почти втрое.</p>
<p>Любопытно, как это до сих пор оставалось незамеченным. Скорее всего, из-за количества объектов — у нас сравнительно небольшая конфигурация. То есть проблемные роли потребляли не так много ресурсов, чтобы мы что-то заподозрили.</p>
        <p class="f6 mt4">
            2019-04-18
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/simple-checkbox/">Простая галочка</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Пару недель назад мы добавили в справочник номенклатуры FirstBIT ERP параметр «Inactive». Задача была простой: если товар больше не нужен пользователю — он ставит галочку и тот исчезает отовсюду (из форм выбора, форм подбора остатков на складах и так далее).</p>
<p>Звучит несложно, правда? Техническая реализация тоже была простой — мы прошлись по всем объектам, в которых предполагается выбор номенклатуры, и добавили дополнительный параметр этого выбора.</p>
<p><img alt="Параметры выбора" src="https://kostyanetsky.ru/notes/simple-checkbox/choice-parameters.png"/></p>
<p>Но пользователи начали жаловаться, что настройка не работает. Мы полезли разбираться и поняли, что забыли про историю ввода — этот механизм, как оказалось, параметры выбора просто игнорирует. То есть пользователи выбирали в инвойсе какой-то товар, потом делали его неактивным, возвращались и инвойс и… Снова видели в истории товар, который вроде только что отключили.</p>
<p>Мы принялись искать выход. Проблема в том, что история ввода хранится в системном хранилище и повлиять на неё программно нельзя. Можно разве что полностью удалить — но фактическая очистка истории происходит только при перезапуске клиента (и то через раз). Отключить историю вообще? Напоминает лечение простуды отсечением головы.</p>
<p>В какой-то момент мы наткнулись на информацию о том, что история ввода хранится не просто для конкретного поля, а ещё и в разрезе параметров выбора. То есть для каждого сочетания параметров выбора и их значений история выбора своя. Получается, если добавить некий дополнительный параметр выбора ко всем полям, где выбирается номенклатура — изменение значения этого параметра будет «чистить» историю (на самом деле, конечно, создавать новую — но пользователю-то какая разница).</p>
<p>В общем, мы создали такой параметр. Хранится в общем хранилище и транслируется в формы при их открытии через общий модуль, который программно добавляет параметр выбора. Если пользователь снимает или устанавливает флаг Inactive для любой номенклатуры — значение параметра меняется, а уже открытые формы получают его через механизм оповещений.</p>
<p><img alt="Минуточку!" src="https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif"/></p>
<p>А ведь как все невинно начиналось, а?</p>
<p>Однако механизм неплохо работает, хотя его недостатки налицо: во-первых, системное хранилище будет постепенно пухнуть по мере появления всё новых и новых сочетаний реальных параметров выбора и нашего, фиктивного. Во-вторых, запись номенклатуры теперь потенциально узкое место: два пользователя не смогут одновременно записать номенклатуры, у которых изменены флаги Inactive (будет блокировка при записи нового значения нашего скрытого параметра выбора в общее хранилище).</p>
<p>Первую проблему можно решить очисткой хранилища по какому-то триггеру, вторую — записью нашего параметра выбора в разрезе пользователей (например, через регистр сведений). Впрочем, мы искренне надеемся, что 1С даст какой-то доступ к истории ввода до того, как нам придется городить дополнительные костыли к тем, что мы уже наворотили :-)</p>
        <p class="f6 mt4">
            2019-03-30
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/duplicate-key/">Повторяющийся ключ</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>На Инфостарте вышла любопытная <a href="https://infostart.ru/public/1010017/" target="_blank">статья</a> про ошибку СУБД «cannot insert duplicate key». Одна из возможных причин сбоя — использование уникального идентификатора объекта для сопоставления при обмене с другими информационными базами (то есть, без служебного регистра, сопоставляющего объекты базы данных с идентификаторами объектов внешней базы).</p>
<p>Такой жести, чтобы уникальные идентификаторы совпали в разных базах для одной и той же таблицы, у меня в практике пока не было. Однако от подхода «единого идентификатора» я отрекся окончательно после того, как делал обмен между <a href="https://firstbit.ae/products/erp-dubai/financial_management/" target="_blank">FirstBIT ERP</a> и <a href="http://superagent.ru/products/grotem_agent" target="_blank">GROTEM / Agent</a>.</p>
<p>Архитектура пилотного решения была такая: данные из FirstBIT ERP выгружались сперва в служебную ИБ 1С, написанную разработчиками GROTEM'а, а уже оттуда — в основную базу данных сервера мобильных приложений.</p>
<p>Сопоставление было сделано очень просто — через идентификаторы объектов. Например, один и тот же документ в обеих базах имел один и тот же идентфикатор. Но были и более сложные схемы: например, контрагент FirstBIT ERP на стороне GROTEM'а превращался в три объекта: собственно контрагента, торговую точку и документ взаиморасчетов.</p>
<p><img alt="WAIT WHAT" src="https://media.giphy.com/media/zkSFsZpQMZuG4/giphy.gif"/></p>
<p>Да, в документ взаиморасчетов. И все три объекта имели один и тот же идентфикатор — идентификатор контрагента FirstBIT ERP. В общем, не то чтобы это было очень изящным решением, но для платформы такой расклад вполне адекватен и мы решили, что проблем быть не должно.</p>
<p>Однако обмен работать отказался.</p>
<p>Беглый анализ показал, что данные успешно выгружаются в промежуточную базу данных и проходят все возможные проверки на целостность и полноту, а не работает только финальный шаг — выгрузка в базу данных сервера мобильных приложений.</p>
<p>В итоге выяснилось, что:</p>
<ol>
<li>В этой самой базе есть таблица, где хранятся все интересующие нас объекты. Документы, элементы справочников, вот это всё.</li>
<li>Эта таблица имеет уникальный индекс по GUID объекта.</li>
</ol>
<p>В этом месте интрига закончилась. Ну да, первый же выгруженный контрагент создавал целых три сущности с одним и тем же GUID, которые прекрасно лежали в своих таблицах на стороне 1С, но не могли быть записаны в одну общую таблицу базы данных приложения.</p>
<p><img alt="I will not use GUIDs to map objects!" src="https://kostyanetsky.ru/notes/duplicate-key/i-will-not-use-guids.gif"/></p>
        <p class="f6 mt4">
            2019-03-01
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/failed-hunt/">Неудачная охота</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>При обновлении платформы до 8.13.12.1790 наткнулись на плавающий баг при переключении текущей страницы элемента на сервере. Конкретно на сервере оно срабатывает, но как только управление возвращается на клиент — текущей страницей становится та, что была до изменения. При этом ещё и происходит событие изменения текущей страницы (как будто пользователь сменил её вручную).</p>
<p>Неприятно, но, в общем, ничего страшного — запатчили баг, описали и зарепортили в 1С. Там пока <a href="https://bugboard.v8.1c.ru/error/000050675.html" target="_blank">думают</a>. Но я, внезапно, даже как-то расстроен — когда расследуешь такие штуки, они всегда выглядят немного загадочно и кажется, что ты вот-вот найдешь что-то интересное! Например, новый аспект работы платформы или что-то вроде этого.</p>
<p>И вот, наконец, ты смотришь на проблему под правильным углом, а она — обычный жук. Возможно, полосатый или в крапинку, но жук как жук — сидит себе, шевелит усами. И ты такой: блин, это что — и есть моя добыча? :-)</p>
        <p class="f6 mt4">
            2019-02-21
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/evolution/">Эволюция</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Говоря о развитии чего-либо (продукта, языка общения, языка программирования и так далее), люди иногда называют это «эволюцией». Мол, процессы похожи — неудачные решения точно так же постепенно вымываются, а удачные — остаются и усиляют сущность, к которой принадлежат. Так-то оно так, но я сейчас вспомнил не про позитивную сторону — фигня в том, что в ходе эволюции потомки, кроме полезных ништяков, получают все хреново выстроенные и зачастую бессмысленные механизмы, которые не смогли прикончить предка.</p>
<p>В итоге мы задерживаем дыхание, когда глотаем, путаемся между dissatisfied и unsatisfactory, а ещё программируем на чудесном языке JavaScript — который, при всём своем удобстве и распостраненности, вобрал в себя все мыслимые и немыслимые недостатки скриптовых языков.</p>
<p>Но это нам ещё везёт — есть, например, жирафы! У этих ребят гортанный нерв сначала спускается по шее на два метра вниз, а потом — поднимается обратно к мышцам гортани (ага, вместо того, чтобы пройти несколько сантиметров от мозга напрямую).</p>
<p>Зная всё это, мне чуть-чуть проще смотреть на то, во что иногда превращается мой код на очередном цикле разработки. Ну и что, что у этого хомячка отрос драконий хвост? Эволюционно, например, такой хвост очень полезен. Кто я такой, чтобы спорить с Дарвином?</p>
<p><a href="https://twitter.com/bluecoders/status/966624401172123649" target="_blank"><img alt="Твит" src="https://kostyanetsky.ru/notes/evolution/snap-tweet-bluecoders-966624401172123649.png"/></a></p>
        <p class="f6 mt4">
            2019-02-16
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/english/">английский</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/string-concatenation/">Конкатенация строк</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Как и многие другие компании, мы даем соискателям тестовое задание. Оно намеренно несложное и нужно больше для того, чтобы посмотреть — насколько кандидат понимает платформу? Как аккуратно работает с объектами конфигурации и её кодом?</p>
<p>Одна из множества мелких штук, которые там проверяются — это формирование длинного сообщения для пользователя, включающее множество параметров. Разработчик может делать это через СтрШаблон() или СтрСоединить(), а может — через простую конкатенацию (соединение) строк. Если кандидат использует последний вариант — это считается небольшим минусом: для пользователя результат будет тот же, но вот понять из кода, как он будет примерно выглядеть — заметно сложнее.</p>
<p>Однако тут есть другой аспект. В первой половине прошлого года «Рарус» опубликовал <a href="http://techlab.rarus.ru/upload/iblock/2/185/Beeline-obespechenie-bespereboynoy-raboti.pdf" target="_blank">отчет</a> о работах, проделанных для «Билайна». Там много любопытного, но среди прочего есть совершенно оглушительный пункт: за счет отказа от соединения строк разработчики добились 40% снижения нагрузки на процессоры! От двух дополнительных серверов после этих изменений вообще отказались, так как они стали не нужны.</p>
<p>Проблема возникала из-за того, чтобы рабочие процессы тратили слишком много времени на распределение памяти для склейки строк. В случае однократного соединения заметной нагрузки не возникает, однако когда мы, например, собираем большой запрос в цикле и делаем это многократно — нагрузка растет лавинообразно. Конкатенацию в таких случаях использовать нельзя, правильный вариант — все те же СтрШаблон() или СтрСоединить(). На старых версиях платформы, где этих методов нет, можно применять объект текстового документа — добавлять в него строки, а потом получать текст.</p>
        <p class="f6 mt4">
            2019-01-27
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/distributed-design/">Распределенный дизайн</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Дизайнер из «Stack Overflow» <a href="http://www.tedgoas.com/blog/distributed-design" target="_blank">написал</a> о том, как они организуют удаленную работу. Понравилась структура текста — не просто «как мы это делаем», а прямо парами: проблема + решение. </p>
<p>У нас в компании почти вся разработка — удаленная и сам я — тоже удаленщик. Мне очень нравится так работать; главное тут — помнить, как легко нахватать самых неожиданных проблем, когда твое рабочее место и твой дом — одно и то же место. Советы из статьи пить воду и вылезать под солнце вполне себе актуальны, например — в ходе какого-нибудь кранча про это и правда легко забыть.</p>
        <p class="f6 mt4">
            2018-10-20
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/different-sides-of-one-coin/">Разные стороны медали</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p><img alt="Привет!" src="https://kostyanetsky.ru/notes/different-sides-of-one-coin/ru.png"/></p>
<p>Фидбек — одна из самых клевых штук в моей профессии. Да, не первый год программирую, да, кучу всего написал, переписал и переделал, и всё равно каждый сложный механизм, наконец заработавший так, как надо — это… Ну, не знаю. Как снова и снова слышать «да» на выпускном бале :-)</p>
<p>Это несколько компенсирует обратную сторону медали — когда ты, например, в стопятый раз пытаешься разобраться в стопяти уровнях абстракции чьего-то приложения, ошибаешься снова и снова, за окном два часа ночи и вместо крови по венам давно бежит кофе.</p>
        <p class="f6 mt4">
            2018-03-05
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/bus-trips-uploading/">Выгрузка автобусных рейсов</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>С тех пор, как мы с коллегами заново автоматизировали <a href="http://kpat.ru/" target="_blank">КПАТ</a>, она работает на «<a href="http://avibus.pro/standalone/" target="_blank">Управлении автовокзалами</a>». Это конфигурация для 1С:Предприятия, то есть её можно сравнительно быстро интегрировать почти с чем угодно.</p>
<p>Первым делом мы решили наладить выгрузку маршрутного расписания автобусов на E-Traffic и Яндекс.Расписания.</p>
<h2>Что это за ресурсы?</h2>
<p>Первый ресурс, <a href="http://e-traffic.ru" target="_blank">E-Traffic</a> — это крупнейший в России агрегатор данных автовокзалов. Собирает информацию о запланированных рейсах и выступает как агент по продаже электронных билетов. То есть пассажирам не нужно продираться через сайты автовокзалов — на E-Traffic можно купить билет откуда угодно куда угодно.</p>
<p>Что касается <a href="http://rasp.yandex.ru" target="_blank">Яндекс.Расписаний</a> — это один из дочерних проектов российского поисковика. Как и E-Traffic, предназначен в первую очередь для пассажиров и умеет быстро строить относительно сложные маршруты с пересадками. Билетами они, правда, не торгуют.</p>
<h2>Как была сделана выгрузка?</h2>
<p>Поначалу мы нагородили довольно сложную архитектуру, позволяющую транслировать расписание в обе системы. Потели как черти — пока в ходе переговоров не выяснилось, что у E-Traffic уже есть рабочий транспорт для передачи расписания в Яндекс, и задача естественным образом не усохла вдвое.</p>
<p>Технически всё было сделано в виде веб-сервиса для «Управления автовокзалами». Получив SOAP-запрос от E-Traffic, он собирал внутри информационной базы 1С:Предприятия все необходимые данные о запланированных автобусных рейсах и возвращал их в виде XML-ки.</p>
<p>Нам даже не пришлось писать код получения расписания с каждого вокзала, входящего в сеть КПАТ'а: все они создаются и хранятся в одном месте — главном узле РИБ, а веб-сервис мы развернули именно там. В итоге больше времени ушло на разные согласования, чем на программирование.</p>
<h2>А где посмотреть?</h2>
<p>Внутренняя кухня снаружи не видна, да и там ничего необычного — роботы общаются с роботами, эка невидаль :-) Результат их болтовни — куда интереснее! Например, вот <a href="https://rasp.yandex.ru/search/bus/?fromName=Кемерово&amp;toName=Новокузнецк&amp;fromId=c64&amp;toId=c237&amp;when=сегодня" target="_blank">расписание</a> рейсов из Кемерово в Новокузнецк на сегодня.</p>
        <p class="f6 mt4">
            2017-11-17
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/done/">готово</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/semiconductors/">Стоп-слова для интерфейсов</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Любопытная <a href="https://bureau.ru/bb/soviet/20161220/" target="_blank">заметка</a> про термины и формулировки, которые лучше не применять при разработке интерфейсов. Позабавила ремарка про аутентификацию и авторизацию.</p>
<p>И, конечно, список выглядит неполным без знаменитых контактов (и полупроводников) :-)</p>
        <p class="f6 mt4">
            2017-01-14
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

            <h2 class="f2 lh-title"><a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/work/avibus-pro/">Авибус</a></h2>

            
    
    <div class="f4 lh-copy black mb5 measure-wide">
        <p>Конфигурация для 1С:Предприятия, которую мы пару лет назад внедряли на кузбасских автовокзалах, обзавелась симпатичной <a href="http://avibus.pro/" target="_blank">обложкой</a>.</p>
<p>По-моему, очень круто! В том числе и тем, что это один из проектов, постепенно разрушающих заплесневелый, но невероятно устойчивый даже среди айтишников миф про 1С — типа, это скучный тормозной софт для бухгалтеров, а настоящие пацаны пишут только на C++ (Java, Javascript, подчеркните, впишите) и тому подобные бредни.</p>
        <p class="f6 mt4">
            2015-02-16
            
                <span class="pl2">
                    <a class="link blue bb dim" href="https://kostyanetsky.ru/notes/tags/1c/">1С</a>
                </span>
            
                <span class="pl2">
                    <a class="link orange bb dim" href="https://kostyanetsky.ru/notes/tags/work/">работа</a>
                </span>
            
        </p>
    </div>



        

        

            <p class="mt5 mb3 f6">
                <a class="link blue bb dim mr1 mt5 mb3" href="https://kostyanetsky.ru/notes/tags/work/page-3">Ранее</a> Ctrl + &darr;
            </p>

        

    </article>


</section>

</main>

<footer class="ph3 ph4-ns pv4 bt b--black-10 black">
    
    <p class="f6 lh-solid">Эл. почта: <a href="mailto:vlad@kostyanetsky.ru" class="link dim bb black">vlad@kostyanetsky.ru</a></p>
    <p class="f6 lh-solid">Телеграм: <a href="tg://resolve?domain=vkostyanetsky" class="link dim bb black">vkostyanetsky</a></p>
    <p class="f6 lh-solid">Гитхаб: <a href="https://github.com/vkostyanetsky" class="link dim bb black">vkostyanetsky</a></p>
    
    <a class="rss" href="https://kostyanetsky.ru/rss.xml">РСС</a> 

</footer>

</div>
</body>
</html>