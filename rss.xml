<rss version="2.0">
    <channel>    
        <title>Влад Костянецкий</title>
        <description>Привет! Меня зовут Влад, я — разработчик приложений для бизнеса.</description>
        <language>ru</language>
        <link>https://kostyanetsky.ru</link>
        <lastBuildDate>Sat, 06 Feb 2021 19:13:53 +0700</lastBuildDate>
        
        <item>
            <title>Проблема с литералом даты при пересчете итогов</title>
            <link>https://kostyanetsky.ru/notes/date-literal-exceeds-3999</link>
            <guid isPermaLink="false">note-date-literal-exceeds-3999</guid>
            <pubDate>Sat, 06 Feb 2021 19:13:53 +0700</pubDate>
            <description><p>Итак, в ходе рутинного пересчета итогов из Конфигуратора мы неожиданно получили ошибку «номер года в литерале типа дата превышает 3999». Это значит, где-то в базе есть (или пытается появиться) дата больше, чем предельно допустимая с точки зрения 1С (31.12.3999 23:59:59).</p>
<p><img alt="Исключение" src="https://kostyanetsky.ru/notes/date-literal-exceeds-3999/excp.png"/></p>
<p>Ладно, что с этим делать?</p>
<p>Главное — выйти на конкретную таблицу с проблемными датами. Ошибка возникла при пересчете итогов, так что очевидно: искать нужно в регистрах. Открываем стандартную обработку управления итогами, делаем пересчет и <a href="https://kostyanetsky.ru/notes/date-literal-exceeds-3999/totals.png" target="_blank">получаем</a> имя регистра, на котором спотыкается платформа.</p>
<p>Другой, более методологически правильный подход — настроить сбор ТЖ (SDBL, EXCP и EXCPCNTX) и получить примерно <a href="https://kostyanetsky.ru/notes/date-literal-exceeds-3999/excp.log" target="_blank">такой</a> лог. Ищем в нём событие EXCP (исключение), а непосредственно перед ним — событие SDBL (SQL-запрос в терминах платформы). Этот запрос — причина сбоя; в его тексте видим имя нужной нам таблицы (AccumRgTn11530). Имя объекта конфигурации для неё можно вытащить любой обработкой, построенной на методе ПолучитьСтруктуруХраненияБазыДанных().</p>
<p>В общем, так или иначе мы получим имя регистра. Открываем его форму и простой сортировкой по периоду выходим на <a href="https://kostyanetsky.ru/notes/date-literal-exceeds-3999/entries.png" target="_blank">проблемные движения</a>. Нужно проанализировать документы, которые их сделали, устранить причину ошибки и перепровести документы. Если после этого проблема с пересчетом останется — это либо не единственная таблица с проблемными датами (ищем дальше), либо эти даты успели засесть где-то ещё, кроме таблицы движений.</p>
<p>Например, у меня был случай, когда после исправления движений записи с некорректными датами сохранялись в таблице оборотов. Средствами платформы их удалить было нельзя, но размер базы позволял играться с реструктуризацией. Я выкинул следующий финт: отключил признак «Использование в итогах» для всех измерений регистра и применил изменения; потом вернул признак на место и пересчитал итоги. В итоге таблица оборотов регистра была физически удалена, а потом создана и наполнена заново — уже без дат на много веков вперёд.</p>
<p>В крайнем случае можно было удалить проблемные записи с помощью прямых SQL-запросов (DELETE или даже TRUNCATE). Но это, во-первых, нарушает лицензионное соглашение с разработчиками платформы, а во вторых — опасно (по неосторожности можно удалить что-то важное и не заметить). Так что не советую, э-э, повторять в домашних условиях :-)</p></description>
        </item>
        
        <item>
            <title>Итоги 2021-го</title>
            <link>https://kostyanetsky.ru/notes/totals-of-2021</link>
            <guid isPermaLink="false">note-totals-of-2021</guid>
            <pubDate>Tue, 08 Feb 2022 13:25:00 +0700</pubDate>
            <description><p>Поздновато я сел итоги подводить, да? Ну, предыдущие пара месяцев вышли, гм, плотными и у меня банально руки не доходили сесть и подумать. А сейчас я как раз в отпуске за 2021-й год — так что самое время. Пишу, типа, из прошлого.</p>
<p>Выписывать каждую ачивку меня совершенно не тянет. Год точно вышел неплохим: я проделал уйму сложной работы над FirstBit ERP (писал новые модули, перепиливал существующие, давил баги, писал функциональные и нагрузочные тесты — да много чего было). Это хорошо сказалось и на самой конфе, и на делах компании. Кроме того, между делом я защитился на эксперта по 1С и на профессионала по PostgreSQL, гип-гип-ура.</p>
<p>Были и фейлы, ну. Перечислять, опять же, лень, но главный провал — я чудовищно разжирел и вместо того, чтобы сбросить килограм десять (таков был изначальный план) — набрал ещё пяток.</p>
<p>Оглядываясь назад, корень большинства проблем за прошлый год вижу так: я слишком сильно фокусировался на потоке задач. Они все были по-своему интересные, от тщательно проработанного ТЗ до челленджей в духе «найди в коде проблему, используя ведьмачье чутьё». Делаешь одну задачу, другую, третью, сотую и сам не замечаешь, что забил почти на всё, кроме работы. В итоге получаешь кучу опыта, но мир усыхает до окна с конфигуратором и сил как-то применять этот опыт нет. Нездоровая фигня.</p>
<p>Короче, если представить меня как персонажа какой-нибудь видеоигры, выглядит так: атака и интеллект за год заметно выросли, но здоровье, подвижность, харизма и вообще почти всё остальное — поползло вниз. Теперь надо с этим всем что-то делать.</p>
<p>Пойду для начала пробегусь километров десять, вот что!</p>
<p><a href="https://twitter.com/EffinBirds/status/1329575199667347459" target="_blank"><img alt="Твит" src="https://kostyanetsky.ru/notes/totals-of-2021/snap-tweet-EffinBirds-1329575199667347459.png"/></a></p>
<p>Возможно, птичка, возможно.</p></description>
        </item>
        
        <item>
            <title>Места лишения свободы</title>
            <link>https://kostyanetsky.ru/notes/places-of-imprisonment</link>
            <guid isPermaLink="false">note-places-of-imprisonment</guid>
            <pubDate>Mon, 23 Feb 2015 21:33:13 +0700</pubDate>
            <description><p>Нашел здорово оформленный <a href="https://kefiijrw.com/army/#intro" target="_blank">дневник</a> российского срочника, ныне — одного из дизайнеров <a href="https://artlebedev.ru" target="_blank">студии</a> Артемия Лебедева. Написано интересно и с юмором, читается — запоем.</p>
<p>С праздником всех причастных!</p></description>
        </item>
        
        <item>
            <title>Профессионал по техвопросам</title>
            <link>https://kostyanetsky.ru/notes/techprof</link>
            <guid isPermaLink="false">note-techprof</guid>
            <pubDate>Sat, 05 Sep 2020 16:52:54 +0700</pubDate>
            <description><p>В конце августа сдал тест на профессионала 1С по техническим вопросам крупных внедрений. Это по сути такой входной билет на <a href="https://1c.ru/rus/partners/training/uc1/course.jsp?id=199" target="_blank">основной экзамен</a>, призванный проредить поток претендентов и заставить их подучить теорию.</p>
<p>В тесте четырнадцать вопросов, случайно набранных из порядка пятиста возможных; нужно правильно ответить хотя бы на двенадцать. На это дается полчаса, однако по факту достаточно пяти-десяти минут: большинство ответов логически выводится или запоминается. Попадаются и неточности, и расплывчатые формулировки, но их мало. Норм вопросы, короче.</p>
<p>Подбор тем показался мне порядочным винегретом — по чуть-чуть из всего подряд. Впрочем, по факту такой охват скорее полезен: смотришь на очередной непривычный вопрос, отвечаешь, ошибаешься. Тушишь задницу, лезешь разбираться как так. Становишься немного умнее (но это не точно).</p></description>
        </item>
        
        <item>
            <title>Объектные блокировки</title>
            <link>https://kostyanetsky.ru/notes/object-locks</link>
            <guid isPermaLink="false">note-object-locks</guid>
            <pubDate>Mon, 22 Apr 2019 18:42:54 +0700</pubDate>
            <description><p>Во-первых, сразу, чтобы не путаться: объектные блокировки платформы никак не связаны с управляемыми блокировками и, тем более, блокировками СУБД. Во-вторых, различают два вида: пессимистические объектные блокировки и оптимистические.</p>
<p>Оба вида неплохо <a href="https://its.1c.ru/db/metod8dev#content:5839:hdoc" target="_blank">описаны</a> на ИТС; ниже — просто краткая выжимка.</p>
<h2>Пессимистические блокировки</h2>
<p>Накладываются расширением формы, когда пользователь начинает редактировать объект — например, меняет значение поля. Если тот же объект попробует отредактировать в форме другой пользователь — форма, которую он открыл, тоже попробует наложить пессимистическую блокировку, не сможет этого сделать и пользователь получит ошибку «Не удалось заблокировать запись».</p>
<p>То есть платформа в данном случае делает своего рода пессимистичную оценку ситуации: мол, раз первый пользователь начал редактировать объект — скорее всего, он его запишет. Раз так, второму пользователю разрешать редактировать нельзя.</p>
<p>Пессимистическую блокировку также можно наложить методом объекта Заблокировать() и снять через метод Разблокировать(). Кроме того, можно воспользоваться методом глобального контекста ЗаблокироватьДанныеДляРедактирования() и методом управляемой формы ЗаблокироватьДанныеФормыДляРедактирования().</p>
<h2>Оптимистические блокировки</h2>
<p>Сперва немного теории: платформа хранит версии объектов ссылочного типа (справочников, документов и так далее). По сути это просто момент времени, в который объект был изменён последний раз. Когда объект считывается расширением формы или кодом — его версия считывается вместе с ним.</p>
<p>Так вот, в момент записи объекта платформа сверяет ту версию, что была получена при чтении объекта из базы данных и ту, что указана в базе данных в момент записи. Если версии различаются — возникает ошибка «Операция не может быть выполнена из-за несоответствия версии или отсутствия записи базы данных».</p>
<p>Это и есть так называемая «оптимистическая блокировка». Называют её так потому, что платформа тянет с проверкой до последнего — пока не произойдет реальной попытки записи.</p>
<p>Наложить оптимистическую блокировку объекта через код нельзя: версия объекта хранится в поле _Version таблицы данных объекта, заполнением которого занимается СУБД. Напрямую изменить это значение средствами платформы нельзя (можно, впрочем, записать объект — тогда его версия изменится).</p></description>
        </item>
        
        <item>
            <title>Большое внедрение 1С</title>
            <link>https://kostyanetsky.ru/notes/big-implementation</link>
            <guid isPermaLink="false">note-big-implementation</guid>
            <pubDate>Tue, 15 Oct 2019 17:56:15 +0700</pubDate>
            <description><p>Что можно считать большим внедрением 1С? Фактически, эта платформа в России используется почти везде — даже в тех компаниях, где широко применяются решения конкурентов (например, тот же SAP). Конечно, где-то объемы внедрения невелики и 1С решает чисто утилитарные задачи вроде формирования отчетности, но среди работ ЦКТП можно найти по-настоящему колоссальные проекты — например, оптимизацию системы «<a href="http://v8.1c.ru/expert/cts/cts-218-001.htm" target="_blank">Деловых линий</a>», которая рассчитана на пять тысяч одновременно работающих пользователей.</p>
<p>В общем, всё это приводит к тому, что средним внедрением в России сейчас считаются базы, в которых одновременно работают сотни пользователей, а большим внедрением — базы, где работают от тысячи пользователей (и больше).</p>
<p>Размер базы при этом — не критерий: есть множество конфигураций, не предполагающих одновременной работы пользователей. Классический пример — 1C:Документооборот, менее классический — «Управление Автовокзалами» Авибуса. Последняя в состоянии накопить в своей центральной базе огромный объем данных от удаленных узлов своей распределенной сети (автовокзалов и автостанцией), однако большое количество одновременно работающих пользователей для нее не характерно.</p></description>
        </item>
        
        <item>
            <title>Столп света</title>
            <link>https://kostyanetsky.ru/notes/pillar-of-light</link>
            <guid isPermaLink="false">note-pillar-of-light</guid>
            <pubDate>Mon, 07 Apr 2014 16:43:54 +0700</pubDate>
            <description><p>Чтение собственного прошлогоднего кода отчетливо отдает мазохизмом: ага, вот тут я неявный запрос в цикле организовал, а вот тут — получил таблицу остатков и зачем-то сгруппировал её. Молодец, дружище!</p>
<p>С другой стороны, это хоть какой-то индикатор роста. Игры играми, но в реальной жизни порой жуть как не хватает каких-нибудь столпов света, падающих с небес при получении нового уровня.</p></description>
        </item>
        
        <item>
            <title>Опочтовиться</title>
            <link>https://kostyanetsky.ru/notes/going-postal</link>
            <guid isPermaLink="false">note-going-postal</guid>
            <pubDate>Mon, 08 May 2023 09:12:34 +0700</pubDate>
            <description><p>Пополнял словарь в попытках описать англоговорящему приятелю свои последние приключения и вычитал про красочную идиому «to go postal». Означает что-то вроде «рехнуться от злости»; появилась где-то между 80-и и 90-и годами в Штатах после серии довольно <a href="https://ru.wikipedia.org/wiki/Going_postal" target="_blank">безумных инцидентов</a>, в которых работники почты ехали крышей и нападали на всех подряд, включая коллег и посетителей.</p>
<p>В общем, выражение на первый взгляд звучит забавно, но уж больно мрачная история за кулисами. Думаю, продолжу применять старое-доброе «to go ballistic». Буквально «разозлиться так, что стать похожим на ракету, потерявшей управление», «взорваться от гнева». </p>
<p>В русском языке, кстати, есть похожие «ракетные» коннотации, но они почему-то про более управляемую или полезную, что ли, историю. Типа, пожар в заднице был настолько силён, что бедняга покинул Землю и успешно приземлился на Марсе (а не просто взорвался) :-)</p></description>
        </item>
        
        <item>
            <title>Поездка на Кок-Коль</title>
            <link>https://kostyanetsky.ru/notes/trip-to-kok-kol</link>
            <guid isPermaLink="false">note-trip-to-kok-kol</guid>
            <pubDate>Sun, 06 Jan 2019 16:23:04 +0700</pubDate>
            <description><p>Летом катался с друзьями на границу с Монголией (на машинах доехали до Ташанты, а оттуда — на велосипедах до <a href="http://rasulka.ru/ооо-расул---кок-коль.html" target="_blank">Кок-Коля</a>). Вымотались как проклятые, однако это того определенно стоило — виды с гор невероятно крутые! Одно жаль, животные попадались нечасто — даже чумных сусликов не встретили, хотя их нам каждый встречный анонсировал, включая погранцев :-)</p>
<iframe allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/4HbJAdYQ-xM" width="560"></iframe></description>
        </item>
        
        <item>
            <title>Задержки PageLatch</title>
            <link>https://kostyanetsky.ru/notes/pagelatch</link>
            <guid isPermaLink="false">note-pagelatch</guid>
            <pubDate>Mon, 22 Apr 2019 20:00:30 +0700</pubDate>
            <description><p>Задержки вида PageIOLatch (я про них сегодня <a href="https://kostyanetsky.ru//notes/pageiolatch" target="_blank">писал</a>) легко встретить в любых системах, в том числе небольших. С задержками PageLatch дела обстоят наоборот — их трудно заметить, пока пользователей меньше нескольких тысяч.</p>
<p>Дело в том, что они возникают, когда страница находится в оперативной памяти и её пытаются изменить несколько пользователей. Пока один пользователь не завершит модификацию — прочие должны ждать. Время ожидания обычно ничтожно, однако если конкурирующих за страницу пользователей много — оно становится заметным.</p>
<p>Возможных причин две.</p>
<h2>Горячее место в индексе</h2>
<p>Такой расклад иногда называют хотспотом. Он возникает, когда мы массово пытаемся писать что-то на последнюю страницу индекса; в первую очередь речь идёт об индексе с монотонно возрастающим ключом — например, любые индексы по полям ссылочного типа (начиная с последних версий 8.2, платформа выдает последовательные GUID — это снижает фрагментацию диска и делает ключ индекса монотонно возрастающим).</p>
<p>Что такое «индекс с монотонно возрастающим ключом»? Для платформы 1С это, например, индексы регистров по периоду. Конечно, они растут не вполне монотонно — однако тут скорее важно, что данные мы всегда будем писать в конец. Сюда же относятся индексы по номеру документа и индексы по коду справочника — в обеих случаях мы выдаем некий новый номер, который пишется в конец индекса.</p>
<p>Решается проблема хотспота только архитектурно — нужно добиться того, чтобы данные записывались в разные места индекса, а не только в конец.</p>
<h2>Системные страницы tempdb</h2>
<p>Когда мы создаём или удаляем таблицу в базе данных, в ней обновляется ряд служебных страниц — IAM (Index Allocation Map), PFS (Page Free Space), GAM (Global Allocation Map), SGAM (Shared Global Allocation Map) и другие.</p>
<p>Почему это важно для tempdb? Для платформы 1С это база, в которой регулярно создается <strong>огромное</strong> количество таблиц. Служебные страницы при этом обновляются настолько часто, что при этом возникают задержки семейства PageLatch.</p>
<p>Вообще-то MS SQL Server умеет оптимизировать обновления системных страниц для tempdb, благодаря чему это делается реже, но иногда даже этого не достаточно. Особенно если в tempdb создаются таблицы с индексами — а это очень частый кейс для приложений на 1С.</p>
<p>У проблемы есть несколько возможных решений. Первый — если СУБД старше 2016-й, можно отключить смешанные экстенты через флаг трассировки 1118. При этом исчезнет необходимость сразу в двух служебных страницах — GAM и SGAM. Соответственно, ожиданий на их обновлении не будет. Экстент — это восемь страниц данных, т.е. 64 килобайта; если он содержит страницы одной таблицы — это нормированный экстент, если нескольких — смешанный.</p>
<p>Второй подход — разбивать tempdb (с 2016-й версии СУБД она, кстати, по умолчанию разбивается на восемь файлов). Дело в том, что служебные страницы ведутся в разрезе файлов; если их будет несколько — ожидания на обновлениях служебных страниц будут ниже.</p>
<p>Третий вариант — уменьшать количество временных таблиц с целью снизить нагрузку на tempdb. То есть переписывать наиболее частотные запросы так, чтобы они работали приемлемо быстро без временных таблиц.</p></description>
        </item>
        
    </channel>
</rss>